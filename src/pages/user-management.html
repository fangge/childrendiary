<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户管理 - 豆豆日记</title>
  <link href="../assets/css/style.css" rel="stylesheet">
  <!-- 引入Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-blue-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">豆豆日记</h1>
      <nav class="space-x-4">
        <a href="../index.html" class="hover:underline">首页</a>
        <a href="./user-management.html" class="hover:underline font-bold">用户管理</a>
        <a href="./diary-management.html" class="hover:underline">写日记</a>
        <a href="./diary-display.html" class="hover:underline">日记展示</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto p-4 mt-8">
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-2xl font-semibold mb-6">用户管理</h2>
      
      <!-- 用户表单 -->
      <form id="userForm" class="mb-8">
        <input type="hidden" id="userId">
        <div class="mb-4">
          <label for="userName" class="block text-gray-700 font-medium mb-2">姓名</label>
          <input type="text" id="userName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 font-medium mb-2">性别</label>
          <div class="flex space-x-4">
            <label class="inline-flex items-center">
              <input type="radio" name="gender" value="男" class="form-radio text-blue-600" checked>
              <span class="ml-2">男</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="gender" value="女" class="form-radio text-blue-600">
              <span class="ml-2">女</span>
            </label>
          </div>
        </div>
        <div class="flex space-x-4">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">保存用户</button>
          <button type="button" id="resetBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">重置</button>
        </div>
      </form>

      <!-- 用户列表 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">用户列表</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-2 px-4 border-b text-left">姓名</th>
                <th class="py-2 px-4 border-b text-left">性别</th>
                <th class="py-2 px-4 border-b text-left">操作</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <!-- 用户数据将通过JavaScript动态添加 -->
            </tbody>
          </table>
        </div>
        <div id="noUsersMessage" class="text-gray-500 italic mt-4 hidden">暂无用户数据</div>
      </div>
    </div>
  </main>

  <footer class="bg-gray-800 text-white p-4 mt-8">
    <div class="container mx-auto text-center">
      <p>© 2025 豆豆日记 - 记录美好生活的每一天</p>
    </div>
  </footer>

  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入API服务 -->
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const userForm = document.getElementById('userForm');
      const userIdInput = document.getElementById('userId');
      const userNameInput = document.getElementById('userName');
      const resetBtn = document.getElementById('resetBtn');
      const userTableBody = document.getElementById('userTableBody');
      const noUsersMessage = document.getElementById('noUsersMessage');
      
      // 加载用户列表
      async function loadUsers() {
        try {
          const users = await DiaryStorage.getUsers();
          userTableBody.innerHTML = '';
          
          if (users.length === 0) {
            noUsersMessage.classList.remove('hidden');
          } else {
            noUsersMessage.classList.add('hidden');
            
            users.forEach(user => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td class="py-2 px-4 border-b">${user.name}</td>
                <td class="py-2 px-4 border-b">${user.gender}</td>
                <td class="py-2 px-4 border-b">
                  <button class="text-blue-600 hover:text-blue-800 mr-2 edit-btn" data-id="${user.id}">编辑</button>
                  <button class="text-red-600 hover:text-red-800 delete-btn" data-id="${user.id}">删除</button>
                </td>
              `;
              userTableBody.appendChild(row);
            });
            
            // 添加编辑按钮事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-id');
                editUser(userId);
              });
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                const userId = this.getAttribute('data-id');
                if (confirm('确定要删除这个用户吗？这将同时删除该用户的所有日记！')) {
                  try {
                    await DiaryStorage.deleteUser(userId);
                    loadUsers();
                  } catch (error) {
                    alert('删除用户失败: ' + error.message);
                  }
                }
              });
            });
          }
        } catch (error) {
          console.error('加载用户列表失败:', error);
          alert('加载用户列表失败，请检查服务器连接');
        }
      }
      
      // 编辑用户
      async function editUser(userId) {
        try {
          const users = await DiaryStorage.getUsers();
          const user = users.find(u => u.id === userId);
          
          if (user) {
            userIdInput.value = user.id;
            userNameInput.value = user.name;
            
            // 设置性别单选按钮
            document.querySelectorAll('input[name="gender"]').forEach(radio => {
              if (radio.value === user.gender) {
                radio.checked = true;
              }
            });
          }
        } catch (error) {
          console.error('获取用户信息失败:', error);
          alert('获取用户信息失败');
        }
      }
      
      // 重置表单
      function resetForm() {
        userForm.reset();
        userIdInput.value = '';
      }
      
      // 表单提交处理
      userForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const userId = userIdInput.value;
        const userName = userNameInput.value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        
        if (!userName.trim()) {
          alert('请输入用户姓名');
          return;
        }
        
        const userData = {
          name: userName,
          gender: gender
        };
        
        try {
          if (userId) {
            // 更新现有用户
            await DiaryStorage.updateUser(userId, userData);
          } else {
            // 添加新用户
            await DiaryStorage.saveUser(userData);
          }
          
          resetForm();
          loadUsers();
        } catch (error) {
          console.error('保存用户失败:', error);
          alert('保存用户失败: ' + error.message);
        }
      });
      
      // 重置按钮事件
      resetBtn.addEventListener('click', resetForm);
      
      // 初始加载用户列表
      loadUsers();
    });
  </script>
</body>
</html>
